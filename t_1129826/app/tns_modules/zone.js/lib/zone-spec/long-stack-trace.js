/**
 * @license
 * Copyright Google Inc. All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
/**
 * @fileoverview
 * @suppress {globalThis}
 */
var NEWLINE = '\n';
var IGNORE_FRAMES = {};
var creationTrace = '__creationTrace__';
var ERROR_TAG = 'STACKTRACE TRACKING';
var SEP_TAG = '__SEP_TAG__';
var sepTemplate = SEP_TAG + '@[native]';
var LongStackTrace = (function () {
    function LongStackTrace() {
        this.error = getStacktrace();
        this.timestamp = new Date();
    }
    return LongStackTrace;
}());
function getStacktraceWithUncaughtError() {
    return new Error(ERROR_TAG);
}
function getStacktraceWithCaughtError() {
    try {
        throw getStacktraceWithUncaughtError();
    }
    catch (err) {
        return err;
    }
}
// Some implementations of exception handling don't create a stack trace if the exception
// isn't thrown, however it's faster not to actually throw the exception.
var error = getStacktraceWithUncaughtError();
var caughtError = getStacktraceWithCaughtError();
var getStacktrace = error.stack ?
    getStacktraceWithUncaughtError :
    (caughtError.stack ? getStacktraceWithCaughtError : getStacktraceWithUncaughtError);
function getFrames(error) {
    return error.stack ? error.stack.split(NEWLINE) : [];
}
function addErrorStack(lines, error) {
    var trace = getFrames(error);
    for (var i = 0; i < trace.length; i++) {
        var frame = trace[i];
        // Filter out the Frames which are part of stack capturing.
        if (!IGNORE_FRAMES.hasOwnProperty(frame)) {
            lines.push(trace[i]);
        }
    }
}
function renderLongStackTrace(frames, stack) {
    var longTrace = [stack ? stack.trim() : ''];
    if (frames) {
        var timestamp = new Date().getTime();
        for (var i = 0; i < frames.length; i++) {
            var traceFrames = frames[i];
            var lastTime = traceFrames.timestamp;
            var separator = "____________________Elapsed " + (timestamp - lastTime.getTime()) + " ms; At: " + lastTime;
            separator = separator.replace(/[^\w\d]/g, '_');
            longTrace.push(sepTemplate.replace(SEP_TAG, separator));
            addErrorStack(longTrace, traceFrames.error);
            timestamp = lastTime.getTime();
        }
    }
    return longTrace.join(NEWLINE);
}
Zone['longStackTraceZoneSpec'] = {
    name: 'long-stack-trace',
    longStackTraceLimit: 10,
    // add a getLongStackTrace method in spec to
    // handle handled reject promise error.
    getLongStackTrace: function (error) {
        if (!error) {
            return undefined;
        }
        var task = error[Zone.__symbol__('currentTask')];
        var trace = task && task.data && task.data[creationTrace];
        if (!trace) {
            return error.stack;
        }
        return renderLongStackTrace(trace, error.stack);
    },
    onScheduleTask: function (parentZoneDelegate, currentZone, targetZone, task) {
        if (Error.stackTraceLimit > 0) {
            // if Error.stackTraceLimit is 0, means stack trace
            // is disabled, so we don't need to generate long stack trace
            // this will improve performance in some test(some test will
            // set stackTraceLimit to 0, https://github.com/angular/zone.js/issues/698
            var currentTask = Zone.currentTask;
            var trace = currentTask && currentTask.data && currentTask.data[creationTrace] || [];
            trace = [new LongStackTrace()].concat(trace);
            if (trace.length > this.longStackTraceLimit) {
                trace.length = this.longStackTraceLimit;
            }
            if (!task.data)
                task.data = {};
            task.data[creationTrace] = trace;
        }
        return parentZoneDelegate.scheduleTask(targetZone, task);
    },
    onHandleError: function (parentZoneDelegate, currentZone, targetZone, error) {
        if (Error.stackTraceLimit > 0) {
            // if Error.stackTraceLimit is 0, means stack trace
            // is disabled, so we don't need to generate long stack trace
            // this will improve performance in some test(some test will
            // set stackTraceLimit to 0, https://github.com/angular/zone.js/issues/698
            var parentTask = Zone.currentTask || error.task;
            if (error instanceof Error && parentTask) {
                var longStack = renderLongStackTrace(parentTask.data && parentTask.data[creationTrace], error.stack);
                try {
                    error.stack = error.longStack = longStack;
                }
                catch (err) {
                }
            }
        }
        return parentZoneDelegate.handleError(targetZone, error);
    }
};
function captureStackTraces(stackTraces, count) {
    if (count > 0) {
        stackTraces.push(getFrames((new LongStackTrace()).error));
        captureStackTraces(stackTraces, count - 1);
    }
}
function computeIgnoreFrames() {
    if (Error.stackTraceLimit <= 0) {
        return;
    }
    var frames = [];
    captureStackTraces(frames, 2);
    var frames1 = frames[0];
    var frames2 = frames[1];
    for (var i = 0; i < frames1.length; i++) {
        var frame1 = frames1[i];
        if (frame1.indexOf(ERROR_TAG) == -1) {
            var match = frame1.match(/^\s*at\s+/);
            if (match) {
                sepTemplate = match[0] + SEP_TAG + ' (http://localhost)';
                break;
            }
        }
    }
    for (var i = 0; i < frames1.length; i++) {
        var frame1 = frames1[i];
        var frame2 = frames2[i];
        if (frame1 === frame2) {
            IGNORE_FRAMES[frame1] = true;
        }
        else {
            break;
        }
    }
}
computeIgnoreFrames();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9uZy1zdGFjay10cmFjZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImxvbmctc3RhY2stdHJhY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztHQU1HO0FBQ0g7OztHQUdHO0FBRUgsSUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDO0FBQ3JCLElBQU0sYUFBYSxHQUF3QixFQUFFLENBQUM7QUFDOUMsSUFBTSxhQUFhLEdBQUcsbUJBQW1CLENBQUM7QUFDMUMsSUFBTSxTQUFTLEdBQUcscUJBQXFCLENBQUM7QUFDeEMsSUFBTSxPQUFPLEdBQUcsYUFBYSxDQUFDO0FBQzlCLElBQUksV0FBVyxHQUFXLE9BQU8sR0FBRyxXQUFXLENBQUM7QUFFaEQ7SUFBQTtRQUNFLFVBQUssR0FBVSxhQUFhLEVBQUUsQ0FBQztRQUMvQixjQUFTLEdBQVMsSUFBSSxJQUFJLEVBQUUsQ0FBQztJQUMvQixDQUFDO0lBQUQscUJBQUM7QUFBRCxDQUFDLEFBSEQsSUFHQztBQUVEO0lBQ0UsTUFBTSxDQUFDLElBQUksS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQzlCLENBQUM7QUFFRDtJQUNFLElBQUksQ0FBQztRQUNILE1BQU0sOEJBQThCLEVBQUUsQ0FBQztJQUN6QyxDQUFDO0lBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUNiLE1BQU0sQ0FBQyxHQUFHLENBQUM7SUFDYixDQUFDO0FBQ0gsQ0FBQztBQUVELHlGQUF5RjtBQUN6Rix5RUFBeUU7QUFDekUsSUFBTSxLQUFLLEdBQUcsOEJBQThCLEVBQUUsQ0FBQztBQUMvQyxJQUFNLFdBQVcsR0FBRyw0QkFBNEIsRUFBRSxDQUFDO0FBQ25ELElBQU0sYUFBYSxHQUFHLEtBQUssQ0FBQyxLQUFLO0lBQzdCLDhCQUE4QjtJQUM5QixDQUFDLFdBQVcsQ0FBQyxLQUFLLEdBQUcsNEJBQTRCLEdBQUcsOEJBQThCLENBQUMsQ0FBQztBQUV4RixtQkFBbUIsS0FBWTtJQUM3QixN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biAqIENvcHlyaWdodCBHb29nbGUgSW5jLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGFuIE1JVC1zdHlsZSBsaWNlbnNlIHRoYXQgY2FuIGJlXG4gKiBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGF0IGh0dHBzOi8vYW5ndWxhci5pby9saWNlbnNlXG4gKi9cbi8qKlxuICogQGZpbGVvdmVydmlld1xuICogQHN1cHByZXNzIHtnbG9iYWxUaGlzfVxuICovXG5cbmNvbnN0IE5FV0xJTkUgPSAnXFxuJztcbmNvbnN0IElHTk9SRV9GUkFNRVM6IHtbazogc3RyaW5nXTogdHJ1ZX0gPSB7fTtcbmNvbnN0IGNyZWF0aW9uVHJhY2UgPSAnX19jcmVhdGlvblRyYWNlX18nO1xuY29uc3QgRVJST1JfVEFHID0gJ1NUQUNLVFJBQ0UgVFJBQ0tJTkcnO1xuY29uc3QgU0VQX1RBRyA9ICdfX1NFUF9UQUdfXyc7XG5sZXQgc2VwVGVtcGxhdGU6IHN0cmluZyA9IFNFUF9UQUcgKyAnQFtuYXRpdmVdJztcblxuY2xhc3MgTG9uZ1N0YWNrVHJhY2Uge1xuICBlcnJvcjogRXJyb3IgPSBnZXRTdGFja3RyYWNlKCk7XG4gIHRpbWVzdGFtcDogRGF0ZSA9IG5ldyBEYXRlKCk7XG59XG5cbmZ1bmN0aW9uIGdldFN0YWNrdHJhY2VXaXRoVW5jYXVnaHRFcnJvcigpOiBFcnJvciB7XG4gIHJldHVybiBuZXcgRXJyb3IoRVJST1JfVEFHKTtcbn1cblxuZnVuY3Rpb24gZ2V0U3RhY2t0cmFjZVdpdGhDYXVnaHRFcnJvcigpOiBFcnJvciB7XG4gIHRyeSB7XG4gICAgdGhyb3cgZ2V0U3RhY2t0cmFjZVdpdGhVbmNhdWdodEVycm9yKCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIHJldHVybiBlcnI7XG4gIH1cbn1cblxuLy8gU29tZSBpbXBsZW1lbnRhdGlvbnMgb2YgZXhjZXB0aW9uIGhhbmRsaW5nIGRvbid0IGNyZWF0ZSBhIHN0YWNrIHRyYWNlIGlmIHRoZSBleGNlcHRpb25cbi8vIGlzbid0IHRocm93biwgaG93ZXZlciBpdCdzIGZhc3RlciBub3QgdG8gYWN0dWFsbHkgdGhyb3cgdGhlIGV4Y2VwdGlvbi5cbmNvbnN0IGVycm9yID0gZ2V0U3RhY2t0cmFjZVdpdGhVbmNhdWdodEVycm9yKCk7XG5jb25zdCBjYXVnaHRFcnJvciA9IGdldFN0YWNrdHJhY2VXaXRoQ2F1Z2h0RXJyb3IoKTtcbmNvbnN0IGdldFN0YWNrdHJhY2UgPSBlcnJvci5zdGFjayA/XG4gICAgZ2V0U3RhY2t0cmFjZVdpdGhVbmNhdWdodEVycm9yIDpcbiAgICAoY2F1Z2h0RXJyb3Iuc3RhY2sgPyBnZXRTdGFja3RyYWNlV2l0aENhdWdodEVycm9yIDogZ2V0U3RhY2t0cmFjZVdpdGhVbmNhdWdodEVycm9yKTtcblxuZnVuY3Rpb24gZ2V0RnJhbWVzKGVycm9yOiBFcnJvcik6IHN0cmluZ1tdIHtcbiAgcmV0dXJuIGVycm9yLnN0YWNrID8gZXJyb3Iuc3RhY2suc3BsaXQoTkVXTElORSkgOiBbXTtcbn1cblxuZnVuY3Rpb24gYWRkRXJyb3JTdGFjayhsaW5lczogc3RyaW5nW10sIGVycm9yOiBFcnJvcik6IHZvaWQge1xuICBsZXQgdHJhY2U6IHN0cmluZ1tdID0gZ2V0RnJhbWVzKGVycm9yKTtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCB0cmFjZS5sZW5ndGg7IGkrKykge1xuICAgIGNvbnN0IGZyYW1lID0gdHJhY2VbaV07XG4gICAgLy8gRmlsdGVyIG91dCB0aGUgRnJhbWVzIHdoaWNoIGFyZSBwYXJ0IG9mIHN0YWNrIGNhcHR1cmluZy5cbiAgICBpZiAoIUlHTk9SRV9GUkFNRVMuaGFzT3duUHJvcGVydHkoZnJhbWUpKSB7XG4gICAgICBsaW5lcy5wdXNoKHRyYWNlW2ldKTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gcmVuZGVyTG9uZ1N0YWNrVHJhY2UoZnJhbWVzOiBMb25nU3RhY2tUcmFjZVtdLCBzdGFjazogc3RyaW5nKTogc3RyaW5nIHtcbiAgY29uc3QgbG9uZ1RyYWNlOiBzdHJpbmdbXSA9IFtzdGFjayA/IHN0YWNrLnRyaW0oKSA6ICcnXTtcblxuICBpZiAoZnJhbWVzKSB7XG4gICAgbGV0IHRpbWVzdGFtcCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZnJhbWVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCB0cmFjZUZyYW1lczogTG9uZ1N0YWNrVHJhY2UgPSBmcmFtZXNbaV07XG4gICAgICBjb25zdCBsYXN0VGltZSA9IHRyYWNlRnJhbWVzLnRpbWVzdGFtcDtcbiAgICAgIGxldCBzZXBhcmF0b3IgPVxuICAgICAgICAgIGBfX19fX19fX19fX19fX19fX19fX0VsYXBzZWQgJHt0aW1lc3RhbXAgLSBsYXN0VGltZS5nZXRUaW1lKCl9IG1zOyBBdDogJHtsYXN0VGltZX1gO1xuICAgICAgc2VwYXJhdG9yID0gc2VwYXJhdG9yLnJlcGxhY2UoL1teXFx3XFxkXS9nLCAnXycpO1xuICAgICAgbG9uZ1RyYWNlLnB1c2goc2VwVGVtcGxhdGUucmVwbGFjZShTRVBfVEFHLCBzZXBhcmF0b3IpKTtcbiAgICAgIGFkZEVycm9yU3RhY2sobG9uZ1RyYWNlLCB0cmFjZUZyYW1lcy5lcnJvcik7XG5cbiAgICAgIHRpbWVzdGFtcCA9IGxhc3RUaW1lLmdldFRpbWUoKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gbG9uZ1RyYWNlLmpvaW4oTkVXTElORSk7XG59XG5cbihab25lIGFzIGFueSlbJ2xvbmdTdGFja1RyYWNlWm9uZVNwZWMnXSA9IDxab25lU3BlYz57XG4gIG5hbWU6ICdsb25nLXN0YWNrLXRyYWNlJyxcbiAgbG9uZ1N0YWNrVHJhY2VMaW1pdDogMTAsICAvLyBNYXggbnVtYmVyIG9mIHRhc2sgdG8ga2VlcCB0aGUgc3RhY2sgdHJhY2UgZm9yLlxuICAvLyBhZGQgYSBnZXRMb25nU3RhY2tUcmFjZSBtZXRob2QgaW4gc3BlYyB0b1xuICAvLyBoYW5kbGUgaGFuZGxlZCByZWplY3QgcHJvbWlzZSBlcnJvci5cbiAgZ2V0TG9uZ1N0YWNrVHJhY2U6IGZ1bmN0aW9uKGVycm9yOiBFcnJvcik6IHN0cmluZyB7XG4gICAgaWYgKCFlcnJvcikge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gICAgY29uc3QgdGFzayA9IChlcnJvciBhcyBhbnkpWyhab25lIGFzIGFueSkuX19zeW1ib2xfXygnY3VycmVudFRhc2snKV07XG4gICAgY29uc3QgdHJhY2UgPSB0YXNrICYmIHRhc2suZGF0YSAmJiB0YXNrLmRhdGFbY3JlYXRpb25UcmFjZV07XG4gICAgaWYgKCF0cmFjZSkge1xuICAgICAgcmV0dXJuIGVycm9yLnN0YWNrO1xuICAgIH1cbiAgICByZXR1cm4gcmVuZGVyTG9uZ1N0YWNrVHJhY2UodHJhY2UsIGVycm9yLnN0YWNrKTtcbiAgfSxcblxuICBvblNjaGVkdWxlVGFzazogZnVuY3Rpb24oXG4gICAgICBwYXJlbnRab25lRGVsZWdhdGU6IFpvbmVEZWxlZ2F0ZSwgY3VycmVudFpvbmU6IFpvbmUsIHRhcmdldFpvbmU6IFpvbmUsIHRhc2s6IFRhc2spOiBhbnkge1xuICAgIGlmIChFcnJvci5zdGFja1RyYWNlTGltaXQgPiAwKSB7XG4gICAgICAvLyBpZiBFcnJvci5zdGFja1RyYWNlTGltaXQgaXMgMCwgbWVhbnMgc3RhY2sgdHJhY2VcbiAgICAgIC8vIGlzIGRpc2FibGVkLCBzbyB3ZSBkb24ndCBuZWVkIHRvIGdlbmVyYXRlIGxvbmcgc3RhY2sgdHJhY2VcbiAgICAgIC8vIHRoaXMgd2lsbCBpbXByb3ZlIHBlcmZvcm1hbmNlIGluIHNvbWUgdGVzdChzb21lIHRlc3Qgd2lsbFxuICAgICAgLy8gc2V0IHN0YWNrVHJhY2VMaW1pdCB0byAwLCBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci96b25lLmpzL2lzc3Vlcy82OThcbiAgICAgIGNvbnN0IGN1cnJlbnRUYXNrID0gWm9uZS5jdXJyZW50VGFzaztcbiAgICAgIGxldCB0cmFjZSA9IGN1cnJlbnRUYXNrICYmIGN1cnJlbnRUYXNrLmRhdGEgJiYgKGN1cnJlbnRUYXNrLmRhdGEgYXMgYW55KVtjcmVhdGlvblRyYWNlXSB8fCBbXTtcbiAgICAgIHRyYWNlID0gW25ldyBMb25nU3RhY2tUcmFjZSgpXS5jb25jYXQodHJhY2UpO1xuICAgICAgaWYgKHRyYWNlLmxlbmd0aCA+IHRoaXMubG9uZ1N0YWNrVHJhY2VMaW1pdCkge1xuICAgICAgICB0cmFjZS5sZW5ndGggPSB0aGlzLmxvbmdTdGFja1RyYWNlTGltaXQ7XG4gICAgICB9XG4gICAgICBpZiAoIXRhc2suZGF0YSkgdGFzay5kYXRhID0ge307XG4gICAgICAodGFzay5kYXRhIGFzIGFueSlbY3JlYXRpb25UcmFjZV0gPSB0cmFjZTtcbiAgICB9XG4gICAgcmV0dXJuIHBhcmVudFpvbmVEZWxlZ2F0ZS5zY2hlZHVsZVRhc2sodGFyZ2V0Wm9uZSwgdGFzayk7XG4gIH0sXG5cbiAgb25IYW5kbGVFcnJvcjogZnVuY3Rpb24oXG4gICAgICBwYXJlbnRab25lRGVsZWdhdGU6IFpvbmVEZWxlZ2F0ZSwgY3VycmVudFpvbmU6IFpvbmUsIHRhcmdldFpvbmU6IFpvbmUsIGVycm9yOiBhbnkpOiBib29sZWFuIHtcbiAgICBpZiAoRXJyb3Iuc3RhY2tUcmFjZUxpbWl0ID4gMCkge1xuICAgICAgLy8gaWYgRXJyb3Iuc3RhY2tUcmFjZUxpbWl0IGlzIDAsIG1lYW5zIHN0YWNrIHRyYWNlXG4gICAgICAvLyBpcyBkaXNhYmxlZCwgc28gd2UgZG9uJ3QgbmVlZCB0byBnZW5lcmF0ZSBsb25nIHN0YWNrIHRyYWNlXG4gICAgICAvLyB0aGlzIHdpbGwgaW1wcm92ZSBwZXJmb3JtYW5jZSBpbiBzb21lIHRlc3Qoc29tZSB0ZXN0IHdpbGxcbiAgICAgIC8vIHNldCBzdGFja1RyYWNlTGltaXQgdG8gMCwgaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvem9uZS5qcy9pc3N1ZXMvNjk4XG4gICAgICBjb25zdCBwYXJlbnRUYXNrID0gWm9uZS5jdXJyZW50VGFzayB8fCBlcnJvci50YXNrO1xuICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgRXJyb3IgJiYgcGFyZW50VGFzaykge1xuICAgICAgICBjb25zdCBsb25nU3RhY2sgPVxuICAgICAgICAgICAgcmVuZGVyTG9uZ1N0YWNrVHJhY2UocGFyZW50VGFzay5kYXRhICYmIHBhcmVudFRhc2suZGF0YVtjcmVhdGlvblRyYWNlXSwgZXJyb3Iuc3RhY2spO1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGVycm9yLnN0YWNrID0gKGVycm9yIGFzIGFueSkubG9uZ1N0YWNrID0gbG9uZ1N0YWNrO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcGFyZW50Wm9uZURlbGVnYXRlLmhhbmRsZUVycm9yKHRhcmdldFpvbmUsIGVycm9yKTtcbiAgfVxufTtcblxuZnVuY3Rpb24gY2FwdHVyZVN0YWNrVHJhY2VzKHN0YWNrVHJhY2VzOiBzdHJpbmdbXVtdLCBjb3VudDogbnVtYmVyKTogdm9pZCB7XG4gIGlmIChjb3VudCA+IDApIHtcbiAgICBzdGFja1RyYWNlcy5wdXNoKGdldEZyYW1lcygobmV3IExvbmdTdGFja1RyYWNlKCkpLmVycm9yKSk7XG4gICAgY2FwdHVyZVN0YWNrVHJhY2VzKHN0YWNrVHJhY2VzLCBjb3VudCAtIDEpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGNvbXB1dGVJZ25vcmVGcmFtZXMoKSB7XG4gIGlmIChFcnJvci5zdGFja1RyYWNlTGltaXQgPD0gMCkge1xuICAgIHJldHVybjtcbiAgfVxuICBjb25zdCBmcmFtZXM6IHN0cmluZ1tdW10gPSBbXTtcbiAgY2FwdHVyZVN0YWNrVHJhY2VzKGZyYW1lcywgMik7XG4gIGNvbnN0IGZyYW1lczEgPSBmcmFtZXNbMF07XG4gIGNvbnN0IGZyYW1lczIgPSBmcmFtZXNbMV07XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgZnJhbWVzMS5sZW5ndGg7IGkrKykge1xuICAgIGNvbnN0IGZyYW1lMSA9IGZyYW1lczFbaV07XG4gICAgaWYgKGZyYW1lMS5pbmRleE9mKEVSUk9SX1RBRykgPT0gLTEpIHtcbiAgICAgIGxldCBtYXRjaCA9IGZyYW1lMS5tYXRjaCgvXlxccyphdFxccysvKTtcbiAgICAgIGlmIChtYXRjaCkge1xuICAgICAgICBzZXBUZW1wbGF0ZSA9IG1hdGNoWzBdICsgU0VQX1RBRyArICcgKGh0dHA6Ly9sb2NhbGhvc3QpJztcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBmcmFtZXMxLmxlbmd0aDsgaSsrKSB7XG4gICAgY29uc3QgZnJhbWUxID0gZnJhbWVzMVtpXTtcbiAgICBjb25zdCBmcmFtZTIgPSBmcmFtZXMyW2ldO1xuICAgIGlmIChmcmFtZTEgPT09IGZyYW1lMikge1xuICAgICAgSUdOT1JFX0ZSQU1FU1tmcmFtZTFdID0gdHJ1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgYnJlYWs7XG4gICAgfVxuICB9XG59XG5jb21wdXRlSWdub3JlRnJhbWVzKCk7XG4iXX0=